# plugins/vulnerability_correlation.py
"""
Vulnerability correlation engine
Identifies attack chains and compound vulnerabilities
"""
from typing import List, Dict, Set

from findings import Finding
from http_client import HttpClient
from targets import Target

PLUGIN_NAME = "vulnerability_correlation"


def run(target: Target, http: HttpClient, all_findings: List[Finding] = None) -> List[Finding]:
    """
    Correlate findings to identify attack chains and compound vulnerabilities.
    """
    findings: List[Finding] = []
    
    if not all_findings or len(all_findings) < 2:
        return findings
    
    # Extract finding patterns
    missing_headers = set()
    exposed_files = []
    dangerous_methods = []
    ssl_issues = []
    
    for f in all_findings:
        msg_lower = f.message.lower()
        
        if 'header' in msg_lower and 'not' in msg_lower:
            # Extract header name
            if 'x-frame-options' in msg_lower:
                missing_headers.add('X-Frame-Options')
            if 'x-content-type-options' in msg_lower:
                missing_headers.add('X-Content-Type-Options')
            if 'strict-transport-security' in msg_lower or 'hsts' in msg_lower:
                missing_headers.add('HSTS')
            if 'content-security-policy' in msg_lower or 'csp' in msg_lower:
                missing_headers.add('CSP')
        
        if f.risk in ['high', 'medium'] and any(x in msg_lower for x in ['backup', 'cert', 'sql', 'dump']):
            exposed_files.append(f)
        
        if 'put' in msg_lower or 'delete' in msg_lower:
            dangerous_methods.append(f)
        
        if 'ssl' in msg_lower or 'tls' in msg_lower or 'certificate' in msg_lower:
            ssl_issues.append(f)
    
    # CORRELATION 1: Multiple missing security headers = weak security posture
    if len(missing_headers) >= 3:
        findings.append(Finding(
            plugin=PLUGIN_NAME,
            url=f"{target.base_url}/",
            message=f"CRITICAL: Multiple security headers missing ({len(missing_headers)} total: {', '.join(missing_headers)}). This indicates a weak security posture and increases attack surface significantly.",
            risk="high",
            status=200,
            nikto_id="900100",
            references="OWASP-A5, OWASP-A6",
            uri="/",
        ))
    
    # CORRELATION 2: Exposed files + dangerous methods = potential data exfiltration
    if exposed_files and dangerous_methods:
        findings.append(Finding(
            plugin=PLUGIN_NAME,
            url=f"{target.base_url}/",
            message=f"ATTACK CHAIN DETECTED: {len(exposed_files)} exposed file(s) + dangerous HTTP methods enabled. Attacker could upload/modify/delete sensitive files.",
            risk="high",
            status=200,
            nikto_id="900101",
            references="OWASP-A5, CWE-434",
            uri="/",
        ))
    
    # CORRELATION 3: SSL issues + missing HSTS = man-in-the-middle risk
    if ssl_issues and 'HSTS' in missing_headers:
        findings.append(Finding(
            plugin=PLUGIN_NAME,
            url=f"{target.base_url}/",
            message="ATTACK CHAIN DETECTED: SSL/TLS issues combined with missing HSTS header. Site is vulnerable to SSL stripping and man-in-the-middle attacks.",
            risk="high",
            status=200,
            nikto_id="900102",
            references="OWASP-A6, CVE-2009-3555",
            uri="/",
        ))
    
    # CORRELATION 4: No CSP + No X-Frame-Options = XSS + Clickjacking risk
    if 'CSP' in missing_headers and 'X-Frame-Options' in missing_headers:
        findings.append(Finding(
            plugin=PLUGIN_NAME,
            url=f"{target.base_url}/",
            message="COMPOUND VULNERABILITY: Missing CSP and X-Frame-Options headers. Site is vulnerable to both XSS and clickjacking attacks simultaneously.",
            risk="high",
            status=200,
            nikto_id="900103",
            references="OWASP-A7, CWE-79, CWE-1021",
            uri="/",
        ))
    
    return findings

