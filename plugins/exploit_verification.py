# plugins/exploit_verification.py
"""
Automatic exploit verification
Verifies if vulnerabilities are actually exploitable
"""
from typing import List
import re

from findings import Finding
from http_client import HttpClient
from targets import Target

PLUGIN_NAME = "exploit_verification"


def run(target: Target, http: HttpClient, all_findings: List[Finding] = None) -> List[Finding]:
    """
    Automatically verify if detected vulnerabilities are exploitable.
    """
    findings: List[Finding] = []
    
    if not all_findings:
        return findings
    
    # Verify PUT method vulnerability
    put_findings = [f for f in all_findings if 'PUT' in f.message and f.risk in ['medium', 'high']]
    if put_findings:
        # Try to actually PUT a test file
        test_url = f"{target.base_url}/test_pynikto_probe.txt"
        test_content = "PyNikto Security Test - Safe to delete"
        
        put_resp = http.request("PUT", test_url, allow_redirects=False)
        if put_resp and put_resp.status_code in [200, 201, 204]:
            # Verify the file was created
            verify_resp = http.get(test_url, allow_redirects=False)
            if verify_resp and verify_resp.status_code == 200:
                findings.append(Finding(
                    plugin=PLUGIN_NAME,
                    url=test_url,
                    message="VERIFIED EXPLOIT: PUT method is ACTUALLY exploitable. Successfully uploaded test file. IMMEDIATE ACTION REQUIRED.",
                    risk="high",
                    status=put_resp.status_code,
                    nikto_id="900200",
                    references="CWE-434, OWASP-A5",
                    uri="/test_pynikto_probe.txt",
                ))
                
                # Try to clean up
                http.request("DELETE", test_url, allow_redirects=False)
    
    # Verify directory listing vulnerabilities
    dir_findings = [f for f in all_findings if 'directory' in f.message.lower() or 'listing' in f.message.lower()]
    if dir_findings:
        for df in dir_findings[:3]:  # Check first 3
            # Verify directory actually lists files
            resp = http.get(df.url, allow_redirects=False)
            if resp and resp.status_code == 200:
                # Look for directory listing indicators
                if any(indicator in resp.text.lower() for indicator in ['index of', 'parent directory', '[dir]', '<pre>']):
                    findings.append(Finding(
                        plugin=PLUGIN_NAME,
                        url=df.url,
                        message="VERIFIED EXPLOIT: Directory listing is ACTUALLY accessible and reveals file structure. Sensitive files may be exposed.",
                        risk="high",
                        status=resp.status_code,
                        nikto_id="900201",
                        references="CWE-548",
                        uri=df.uri or "/",
                    ))
    
    # Verify SQL injection indicators
    sql_findings = [f for f in all_findings if 'sql' in f.message.lower()]
    if sql_findings:
        for sf in sql_findings[:2]:  # Check first 2
            # Try basic SQL injection test
            test_url = sf.url
            if '?' in test_url:
                test_url += "&test=1' OR '1'='1"
            else:
                test_url += "?test=1' OR '1'='1"
            
            test_resp = http.get(test_url, allow_redirects=False)
            if test_resp:
                # Look for SQL error messages
                sql_errors = [
                    'sql syntax', 'mysql', 'postgresql', 'ora-', 'sqlite',
                    'syntax error', 'unclosed quotation', 'quoted string'
                ]
                if any(err in test_resp.text.lower() for err in sql_errors):
                    findings.append(Finding(
                        plugin=PLUGIN_NAME,
                        url=test_url,
                        message="VERIFIED EXPLOIT: SQL injection vulnerability confirmed. Database error messages detected in response. CRITICAL VULNERABILITY.",
                        risk="high",
                        status=test_resp.status_code,
                        nikto_id="900202",
                        references="CWE-89, OWASP-A1",
                        uri=sf.uri or "/",
                    ))
    
    # Verify XSS vulnerabilities
    xss_findings = [f for f in all_findings if 'xss' in f.message.lower() or 'script' in f.message.lower()]
    if xss_findings:
        # Test for reflected XSS
        test_payload = "<script>alert('PyNikto')</script>"
        test_url = f"{target.base_url}/?test={test_payload}"
        
        xss_resp = http.get(test_url, allow_redirects=False)
        if xss_resp and test_payload in xss_resp.text:
            findings.append(Finding(
                plugin=PLUGIN_NAME,
                url=test_url,
                message="VERIFIED EXPLOIT: Reflected XSS vulnerability confirmed. Payload was echoed in response without sanitization. CRITICAL VULNERABILITY.",
                risk="high",
                status=xss_resp.status_code,
                nikto_id="900203",
                references="CWE-79, OWASP-A7",
                uri="/?test=...",
            ))
    
    return findings

